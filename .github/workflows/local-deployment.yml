name: Local Pi Cluster Deployment

on:
  push:
    branches: [ main ]
    paths:
      - 'k3s/**/*.yaml'
      - 'k3s/**/*.yml'
  workflow_dispatch:
    inputs:
      deployment_method:
        description: 'Deployment method'
        required: true
        default: 'manual'
        type: choice
        options:
        - manual
        - webhook
        - polling

jobs:
  prepare-deployment:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate manifests
      run: |
        echo "ðŸ” Validating YAML syntax..."
        for file in $(find k3s -name "*.yaml" -o -name "*.yml"); do
          echo "Validating $file"
          kubectl --dry-run=client apply -f "$file" || {
            echo "âŒ Validation failed for $file"
            exit 1
          }
        done
        echo "âœ… All YAML files are valid"

    - name: Create deployment package
      run: |
        echo "ðŸ“¦ Creating deployment package..."
        
        # Create a deployment package
        mkdir -p deployment-package
        cp -r k3s/* deployment-package/
        
        # Create deployment script
        cat > deployment-package/deploy-local.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸš€ Deploying to local Pi cluster..."
        
        # Apply configurations in order
        echo "ðŸ“ Applying namespaces..."
        kubectl apply -f namespaces/ || echo "âš ï¸ Some namespaces may already exist"
        
        echo "ðŸ” Applying secrets..."
        kubectl apply -f secrets/
        
        echo "ðŸ“Š Applying monitoring stack..."
        kubectl apply -f applications/monitoring/prometheus/
        
        echo "ðŸ½ï¸ Applying Mealie..."
        kubectl apply -f applications/mealie/
        
        echo "ðŸ”’ Applying cert-manager configurations..."
        kubectl apply -f certmanager/
        
        echo "ðŸŒ Applying MetalLB configuration..."
        kubectl apply -f metalLB/metallb-config.yaml
        
        echo "âœ… Deployment completed!"
        
        # Show status
        echo "ðŸ“Š Pod Status:"
        kubectl get pods -A | grep -E "(prometheus|mealie|grafana|postgres)"
        EOF
        
        chmod +x deployment-package/deploy-local.sh
        
        # Create a compressed package
        tar -czf deployment-package.tar.gz deployment-package/
        
        echo "ðŸ“¦ Deployment package created: deployment-package.tar.gz"

    - name: Upload deployment package
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deployment-package.tar.gz
        retention-days: 7

    - name: Generate deployment instructions
      run: |
        echo "ðŸ“‹ Local Deployment Instructions" >> $GITHUB_STEP_SUMMARY
        echo "================================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— Download the deployment package from the Actions artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¥ To deploy to your local Pi cluster:" >> $GITHUB_STEP_SUMMARY
        echo "1. Download \`deployment-package.tar.gz\` from the Actions artifacts" >> $GITHUB_STEP_SUMMARY
        echo "2. Transfer to your Pi cluster master node" >> $GITHUB_STEP_SUMMARY
        echo "3. Extract and run: \`tar -xzf deployment-package.tar.gz && cd deployment-package && ./deploy-local.sh\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”„ Or use the automated methods below:" >> $GITHUB_STEP_SUMMARY
        echo "- Webhook deployment (if webhook server is running)" >> $GITHUB_STEP_SUMMARY
        echo "- Polling deployment (if polling script is running)" >> $GITHUB_STEP_SUMMARY
