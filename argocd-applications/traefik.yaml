apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: traefik
  namespace: argocd
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://traefik.github.io/charts
    chart: traefik
    targetRevision: 35.4.0
    helm:
      values: |
        # Deploy as DaemonSet for proper k3s integration and HA
        deployment:
          kind: DaemonSet
          replicas: 1
          podAnnotations:
            prometheus.io/port: "8082"
            prometheus.io/scrape: "true"
        
        # DNS configuration
        dnsPolicy: ClusterFirst
        dnsConfig:
          options:
          - name: ndots
            value: "2"
          - name: single-request
          - name: single-request-reopen
          - name: timeout
            value: "5"
          - name: attempts
            value: "3"
        additionalArguments:
        - --entrypoints.web.transport.lifeCycle.graceTimeOut=10s
        - --entrypoints.web.transport.respondingTimeouts.idleTimeout=30s
        global:
          systemDefaultRegistry: ""
        image:
          repository: rancher/mirrored-library-traefik
          tag: 3.3.6
        priorityClassName: system-cluster-critical
        providers:
          kubernetesIngress:
            publishedService:
              enabled: true
            ingressClass: traefik
            allowCrossNamespace: false
            allowExternalNameServices: false
            allowEmptyServices: false
            ingressEndpoint:
              hostname: 10.0.2.1
              ip: 10.0.2.1
        serversTransport:
          insecureSkipVerify: true
          maxIdleConnsPerHost: 10
          forwardingTimeouts:
            dialTimeout: 30s
            responseHeaderTimeout: 30s
            idleConnTimeout: 30s
            readIdleTimeout: 30s
            pingTimeout: 15s
        log:
          level: DEBUG
          access:
            enabled: true
            format: json
            fields:
              defaultMode: keep
              headers:
                defaultMode: keep
        accessLog:
          enabled: true
          format: json
          fields:
            defaultMode: keep
            headers:
              defaultMode: keep
        certificatesResolvers:
          letsencrypt:
            acme:
              tlsChallenge: {}
              email: colin@cooklabs.net
              storage: /data/acme.json
              caServer: https://acme-v02.api.letsencrypt.org/directory
        persistence:
          enabled: false
        service:
          type: LoadBalancer
          ipFamilyPolicy: PreferDualStack
          loadBalancerIP: 10.0.1.200
          externalTrafficPolicy: Local
        tolerations:
        - key: CriticalAddonsOnly
          operator: Exists
        - effect: NoSchedule
          key: node-role.kubernetes.io/control-plane
          operator: Exists
        - effect: NoSchedule
          key: node-role.kubernetes.io/master
          operator: Exists
  destination:
    server: https://kubernetes.default.svc
    namespace: kube-system
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - PrunePropagationPolicy=foreground
    - PruneLast=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  revisionHistoryLimit: 10
